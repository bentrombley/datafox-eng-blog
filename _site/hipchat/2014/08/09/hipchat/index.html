<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Automate Everything Using Hipchat</title>
    <meta name="viewport" content="width=device-width">
    <meta name="description" content="DataFox Tech Blog">
    <link rel="canonical" href="http://datafox.co/hipchat/2014/08/09/hipchat/">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/main.css">

</head>


    <body>

    <header class="site-header">

  <div class="wrap">

    <a class="site-title" href="/">DataFox Tech Blog</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
           viewBox="0 0 18 15" enable-background="new 0 0 18 15" xml:space="preserve">
          <path fill="#505050" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0
            h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#505050" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484
            h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#505050" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0
            c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>
      <div class="trigger">
        
          <a class="page-link" href="/about/">About</a>
        
          <a class="page-link" href="/feed.xml"></a>
        
          <a class="page-link" href="/"></a>
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrap">
      <div class="post">

  <header class="post-header">
    <h1>Automate Everything Using Hipchat</h1>
    <p class="meta">Aug 9, 2014</p>
  </header>

  <article class="post-content">
  <p>We’re huge fans of <a href="https://www.hipchat.com/">HipChat</a> here at DataFox and it has rapidly become our central means of communication.</p>

<p>We started by using it as a simple instant messenger for 1:1 conversations, and then expanded to using the chat rooms as a way to send out customer feedback without clogging our inboxes.  And it has become the way to broadcast announcements like <code>@all order lunch from [doordash](http://doordash.com)</code>.</p>

<p>But that’s just the beginning.  HipChat is also <em>the</em> simplest way to communicate with our automated tools and processes.  No more e-mails or dashboards spread across 10 different systems.  By consolidating our messaging through HipChat we get all of our alerts in one place and can instantly discuss everything that is happening.</p>

<h3 id="deployment-and-configuration">Deployment and Configuration</h3>

<h4 id="continuous-integration">Continuous Integration</h4>

<p><a href="http://jenkins-ci.org/">Jenkins</a> has become the standard way to run continuous integration and deployment, and it defaults to e-mailing you when builds or tests fail.  But if you’re like me, you’ve already set up e-mail filters to ignore this noise.</p>

<p>Fortunately, it takes less than 5 minutes to install and configure the <a href="https://wiki.jenkins-ci.org/display/JENKINS/HipChat+Plugin">HipChat plugin</a> to broadcast when builds fail.  Now everyone sees a growl notification on failure (configurable, of course) and you can discuss the issue right there with your team.  No more e-mail threads!</p>

<h4 id="deployment">Deployment</h4>
<p>We use <a href="http://docs.ansible.com/index.html">Ansible</a> for all of our deployment and configuration, and highly recommend it.  Ansible is designed to simple and powerful, with almost no setup.  For example, Ansible comes with a hipchat module that makes it trivial to broadcast when you’ve deployed code to a server:</p>

<pre><code>---
# ... steps to deploy your code ...

- name: "Broadcast deployment in hipchat"
  hipchat: token= room= msg=" server deployed."
</code></pre>

<p>And in your <code>vars.yml</code> file you define these two variables (inventory_hostname is the server name, like “db.datafox.co”)</p>

<pre><code>---
hipchat_api_key: ...
hipchat_engineering_room_id: ...
</code></pre>

<p>This shows up as an alert like:
(screenshot of deployment notifications, blur out actual server name?)</p>

<p>Similarly, it’s trivial to broadcast changes in configuration.  Have you ever wasted 4 hours debugging an issue only to learn that someone has had just updated a conf file?  With a few lines in ansible you can create a log of all changes to your production servers.</p>

<h3 id="monitoring">Monitoring</h3>

<p><a href="http://mmonit.com/monit/">Monit</a> is a very lightweight and powerful tool for monitoring your servers and services.  For example, we can alert if a server is running out of storage, by creating a file at <code>/etc/monit/conf.d/diskspace</code>:</p>

<pre><code>check filesystem rootfs with path /
if space usage &gt; 80% then alert
</code></pre>

<p>similarly, it’s easy to monitor our various backend services and remote connections.  By default monit will send alert e-mails, but it’s far more useful to have the messages sent to hipchat where they can trigger a growl notification and show up in context of any recent deployments or other changes.</p>

<p>To make this work we just wrote a quick-and-dirty python script to send hipchat messages:</p>

<pre><code>import sys, urllib, urllib2, json

values = {
  'room_id'        : 12345,
  'message'        : 'message to send',
  'color'          : 'red',
  'from'           : 'server.datafox.co',
  'notify'         : 0,
  'message_format' : 'text'
}

# yes, this should use optparse...
last_command = ''
for i, arg in enumerate(sys.argv):
  if i % 2 == 1:
    last_command = arg
  elif i != 0:
    if last_command == '-m':
      values['message'] = arg
    elif last_command == '-f':
      values['from'] = arg
    elif last_command == '-r':
      room_id = arg
    elif last_command == '-c':
      values['color'] = arg
    elif last_command == '-n':
      values['notify'] = arg
    elif last_command == '-fm':
      values['format'] = arg
    else:
      print 'Unrecognized argument: ' + last_command
      sys.exit()

url = 'https://api.hipchat.com/v1/rooms/message?auth_token= ...'
req = urllib2.Request(url, urllib.urlencode(values))
urllib2.urlopen(req)
</code></pre>

<p>And then invoke it from monit like:</p>

<pre><code># if service is unavailable 3 times in a row, send an alert that we are restarting
if failed host localhost port 12345 protocol http for 3 cycles then restart
then exec "/var/hipchat/hipchat_cli.py -m 'some-server process failed on server.datafox.co -- restarting.' -f 'Monit' -n 1"
</code></pre>

<h3 id="bugs-and-uncaught-exceptions">Bugs and Uncaught Exceptions</h3>

<p>We use <a href="https://bugsnag.com">Bugsnag</a> to report uncaught errors in our frontend JavaScript, as well as in our backend NodeJS and Python services.  I haven’t used any of the competing products, but Bugsnag was extremely easy to setup and automatically groups all errors,  so we are alerted the 1st, 10th, 100th, etc. time an error occurs.</p>

<p>Connecting Bugsnag to HipChat takes less than 60 seconds, and now we can immediately see if the errors started occurring after a deployment.</p>

<h3 id="and-more">And More…</h3>

<p>With widespread adoption it seems like most cloud-based services support HipChat.  We particularly rely on NewRelic alerts, but also use Github.  The only concern is drowning out the useful signal with noise (e.g. github commits).</p>

<p><img src="/img/hipchat-screenshot.png" style="width: 100%" />
<small><b>Pictured Above:</b> HipChat showing a git push to our Master branch, followed by an automated Jenkins build and Ansible deployment. Unfortunately, this deployment resulted in a bug which was subsequently caught by bugsnag and displayed prominently in HipChat.</small></p>

  </article>

</div>
      </div>
    </div>

    <footer class="site-footer">

  <div class="wrap">

    <h2 class="footer-heading">DataFox Tech Blog</h2>

    <div class="footer-col-1 column">
      <ul>
        <li>DataFox Tech Blog</li>
        <li><a href="mailto:"></a></li>
      </ul>
    </div>

    <div class="footer-col-2 column">
      <ul>
        <li>
          <a href="https://github.com/">
            <span class="icon github">
              <svg version="1.1" class="github-icon-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                 viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
                <path fill-rule="evenodd" clip-rule="evenodd" fill="#C2C2C2" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761
                c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32
                c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472
                c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037
                C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65
                c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261
                c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082
                c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129
                c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
              </svg>
            </span>
            <span class="username"></span>
          </a>
        </li>
        <li>
          <a href="https://twitter.com/">
            <span class="icon twitter">
              <svg version="1.1" class="twitter-icon-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                 viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
                <path fill="#C2C2C2" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27
                c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767
                c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206
                C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271
                c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469
                c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
              </svg>
            </span>
            <span class="username"></span>
          </a>
        </li>
      </ul>
    </div>

    <div class="footer-col-3 column">
      <p class="text">DataFox Tech Blog</p>
    </div>

  </div>

</footer>


    </body>
</html>
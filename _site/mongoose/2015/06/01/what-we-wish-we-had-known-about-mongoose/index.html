<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>What We Wish We Had Known About Mongoose</title>
    <meta name="viewport" content="width=device-width">
    <meta name="description" content="DataFox Tech Blog">
    <link rel="canonical" href="http://datafox.co/mongoose/2015/06/01/what-we-wish-we-had-known-about-mongoose/">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/main.css">

    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</head>


    <body>

    <header class="site-header">

  <div class="wrap">

    <a class="site-title" href="/">DataFox Tech Blog</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
           viewBox="0 0 18 15" enable-background="new 0 0 18 15" xml:space="preserve">
          <path fill="#505050" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0
            h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#505050" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484
            h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#505050" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0
            c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>
      <div class="trigger">
        
          <a class="page-link" href="/about/">About</a>
        
          <a class="page-link" href="/feed.xml"></a>
        
          <a class="page-link" href="/"></a>
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrap">
      <div class="post">

  <header class="post-header">
    <h1>What We Wish We Had Known About Mongoose</h1>
    <p class="meta">Jun 1, 2015</p>
  </header>

  <article class="post-content">
  <p>At DataFox we use <a href="http://mongoosejs.com/">mongoose</a> as an ORM layer that abstracts our MongoDB calls. Generally, we benefit from cleaner, more modular code that hides the nitty-gritty details of the MongoDB driver - but mongoose isn’t perfect and it certainly doesn’t abstract all of the problems that can occur when using MongoDB.</p>

<p>As such, we decided to collect a list of “gotchas” that might be useful to others beginning to use mongoose in a production environment…</p>

<h2 id="beware-of-ensureindex">Beware of ensureIndex()</h2>

<p>One major benefit to using Mongoose is that you can define the schema for your collections (i.e. SQL tables) in code, making it easy to modify the schema without a database migration. Mongoose further adds support for defining indexes in code like so:</p>

<div class="highlight"><pre><code class="coffeescript"><span class="nv">schema = </span><span class="k">new</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">Schema</span><span class="p">({</span>
  <span class="nv">name: </span><span class="nb">String</span>
  <span class="p">...</span>
<span class="p">})</span>

<span class="c1"># index on name</span>
<span class="nx">schema</span><span class="p">.</span><span class="nx">index</span><span class="p">({</span><span class="nv">name: </span><span class="mi">1</span><span class="p">})</span>

<span class="nv">module.exports = </span><span class="nx">mongoose</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s">&#39;Company&#39;</span><span class="p">,</span> <span class="nx">schema</span><span class="p">)</span></code></pre></div>

<p>Mongoose supports all of the advanced index parameters, so you can create unique indexes, compound indexes and indexes on subdocuments or arrays.</p>

<p>In practice this works because Mongoose automatically calls <code>ensureIndex()</code> when the module is required. If the index exists, the call is ignored, but if the index is new, MongoDB will immediately build the index and replicate the command to all secondaries.</p>

<p>In most cases this is fine, but on a large table the command will lock all writes for a significant amount of time. Furthermore if you are applying a unique index to a field that is not currently unique, the command will fail – or if a duplicate occurs on the secondary the entire database will shut down.</p>

<p>The drastic solution is to disable ensureIndex on production environments like:</p>

<div class="highlight"><pre><code class="coffeescript"><span class="k">new</span> <span class="nx">Schema</span><span class="p">({...},</span> <span class="p">{</span><span class="nv">autoIndex: </span><span class="kc">false</span><span class="p">})</span></code></pre></div>

<p>A compromise (while you’re small) is to simply expect the call as part of a code deployment and ensure it happens in off-peak hours after testing.</p>

<h2 id="ensure-index-can-fail-silently">Ensure Index Can Fail Silently</h2>

<p>A far more insidious problem, however, is that when a call to <code>ensureIndex()</code> fails the error is swallowed, leading to bizarre behavior where <code>find()</code> queries return truncated results. There is an open <a href="https://github.com/Automattic/mongoose/issues/609">mongoose issue</a> for this and it points to the root cause as this as-yet unresolved <a href="https://jira.mongodb.org/browse/SERVER-4462">MongoDB issue</a>.</p>

<h2 id="catch-connection-failures">Catch Connection Failures</h2>

<p>Be careful to subscribe to the error hooks when you connect to the database, or you’ll be stuck with silent failures.</p>

<div class="highlight"><pre><code class="coffeescript"><span class="nv">dbInstance = </span><span class="k">new</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">Mongoose</span><span class="p">()</span>
<span class="nx">dbInstance</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">DB_URL</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span>
<span class="nx">dbInstance</span><span class="p">.</span><span class="nx">connection</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s">&quot;error&quot;</span><span class="p">,</span> <span class="nf">(err) -&gt;</span>
  <span class="c1"># log error...</span>
<span class="p">)</span></code></pre></div>

<h2 id="prevent-cpu-spikes-by-using-lean-models">Prevent CPU Spikes by Using Lean Models</h2>
<p>By default when you call a method like <code>find()</code> or <code>findOne()</code>, Mongoose returns a full model complete with mongoose methods and virtuals. For example:</p>

<div class="highlight"><pre><code class="coffeescript"><span class="nx">User</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="nv">email: </span><span class="s">&quot;data@datafox.co&quot;</span><span class="p">},</span> <span class="nf">(err, user) =&gt;</span>
  <span class="p">...</span>
  <span class="nv">user.status = </span><span class="mi">1</span>
  <span class="c1"># save() method works</span>
  <span class="nx">user</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span>
<span class="p">)</span></code></pre></div>

<p>This works in most cases, but in bulk the work of constructing thousands of mongoose objects from the database, results can become CPU-bound, causing CPU thrashing which blocks Node (and everything else on the server).</p>

<p>The solution in most cases is to add the <code>lean()</code> parameter to your query so mongoose returns only the raw JS object. For example:</p>

<div class="highlight"><pre><code class="coffeescript"><span class="nx">Company</span><span class="p">.</span><span class="nx">find</span><span class="p">().</span><span class="nx">lean</span><span class="p">().</span><span class="nx">exec</span><span class="p">(</span><span class="nf">(err, allTheCompanies) =&gt;</span>
  <span class="p">...</span>
<span class="p">)</span></code></pre></div>

<p>You no longer can call methods like <code>save()</code> or use virtuals\ fields, but in most bulk cases this is acceptable.</p>

<p>Unfortunately, this means sacrificing some the encapsulation afforded by defining methods on your models, but in the long run it’s better to treat mongoose models as simple MongoDB documents, rather than full-blown classes.</p>

<h2 id="learn-to-love-streams">Learn to Love Streams</h2>

<p>Streams are one of the best parts of NodeJS, allowing you to process large data sets efficiently, but it remains buggy and awkward in many libraries… including Mongoose. Here’s how to make it work:</p>

<h3 id="use-streamworker">Use StreamWorker</h3>

<p>StreamWorker makes using streams trivial by hiding the awkward query hooks. To improve our previous example:</p>

<div class="highlight"><pre><code class="coffeescript"><span class="nv">stream = </span><span class="nx">Company</span><span class="p">.</span><span class="nx">find</span><span class="p">().</span><span class="nx">lean</span><span class="p">().</span><span class="nx">stream</span><span class="p">()</span> <span class="c1"># note that the lean() command works here too</span>
<span class="nv">PARALLELISM = </span><span class="mi">5</span>
<span class="nx">StreamWorker</span><span class="p">(</span><span class="nx">stream</span><span class="p">,</span> <span class="nx">PARALLELISM</span><span class="p">,</span> <span class="nx">processOneCompany</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span></code></pre></div>

<p>Now we can define a callback like <code>processOneCompany</code> which will handle the companies one-at-a-time, and StreamWorker will handle the annoying on finish hooks.</p>

<h3 id="prevent-timeouts">Prevent Timeouts</h3>

<p>One disastrous and silent error can occur when processing a very long streaming query: a timeout. This can happen at either the network level or the database level, so you need to guard against both.</p>

<p>First when connecting to the database specify the “keepAlive” parameter to prevent a network disconnect on a long-running query.</p>

<div class="highlight"><pre><code class="coffeescript"><span class="nv">mongooseInstance = </span><span class="k">new</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">Mongoose</span><span class="p">()</span>
<span class="nv">options = </span><span class="p">{</span>
  <span class="nv">user: </span><span class="nx">config</span><span class="p">.</span><span class="nx">DB_USER</span>
  <span class="nv">pass: </span><span class="nx">config</span><span class="p">.</span><span class="nx">DB_PASS</span>
  <span class="nv">server: </span><span class="p">{</span><span class="nv">socketOptions: </span><span class="p">{</span><span class="nv">keepAlive: </span><span class="mi">1</span><span class="p">}}</span>
  <span class="nv">replset: </span><span class="p">{</span><span class="nv">socketOptions: </span><span class="p">{</span><span class="nv">keepAlive: </span><span class="mi">1</span><span class="p">}}</span>
<span class="p">}</span>
<span class="nx">mongooseInstance</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">DB_URL</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span></code></pre></div>

<p>Second and just as importantly, don’t forget to set the <code>timeout</code> parameter to false.</p>

<div class="highlight"><pre><code class="coffeescript"><span class="nx">User</span><span class="p">.</span><span class="nx">find</span><span class="p">().</span><span class="nx">setOptions</span><span class="p">({</span><span class="nv">timeout: </span><span class="kc">false</span><span class="p">})</span></code></pre></div>

<p>Note that you may still run into configurations in MongoDB or your network that can cause similar disconnect issues, but this will solve most cases.</p>

<h3 id="dont-forget-to-catch-errors">Don’t Forget to Catch Errors</h3>

<p>You must subscribe to the stream’s <code>on('error')</code> or you can experience silent failures as the error is caught and never returned to the callback.</p>

<h2 id="use-schema-plugins-to-add-created-and-updated-timestamps">Use Schema Plugins to add Created and Updated Timestamps</h2>

<p>Mongoose supports “plugins” which behave like a mixin or trait. This let’s you easily define methods and attributes across all of your models. One of the most useful, in our experience, is automatically saving the created and last-modified times on all models, which makes debugging vastly simpler.</p>

<p>Here is is the plugin:</p>

<div class="highlight"><pre><code class="coffeescript"><span class="c1"># plugin for mtime/ctime</span>
<span class="nv">module.exports.timestamps = </span><span class="nf">(schema, options) -&gt;</span>
  <span class="nx">schema</span><span class="p">.</span><span class="nx">add</span><span class="p">({</span><span class="nv">ctime: </span><span class="p">{</span><span class="nv">type: </span><span class="nb">Date</span><span class="p">}})</span>
  <span class="nx">schema</span><span class="p">.</span><span class="nx">add</span><span class="p">({</span><span class="nv">mtime: </span><span class="p">{</span><span class="nv">type: </span><span class="nb">Date</span><span class="p">}})</span>

  <span class="nx">schema</span><span class="p">.</span><span class="nx">pre</span><span class="p">(</span><span class="s">&#39;save&#39;</span><span class="p">,</span> <span class="nf">(next) -&gt;</span>
    <span class="vi">@ctime = </span><span class="k">new</span> <span class="nb">Date</span> <span class="k">if</span> <span class="nx">@isNew</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">@ctime</span><span class="o">?</span>
    <span class="vi">@mtime = </span><span class="k">new</span> <span class="nb">Date</span>
    <span class="nx">next</span><span class="p">()</span>
  <span class="p">)</span></code></pre></div>

<p>Use it like so:</p>

<div class="highlight"><pre><code class="coffeescript"><span class="nv">plugins = </span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;plugins&#39;</span><span class="p">)</span>
<span class="nx">schema</span><span class="p">.</span><span class="nx">plugin</span><span class="p">(</span><span class="nx">plugins</span><span class="p">.</span><span class="nx">timestamps</span><span class="p">)</span></code></pre></div>

<h2 id="conclusion">Conclusion</h2>

<p>We hope you found these mongoose gotchyas and solutions useful. Both mongo and mongoose are evolving and hopefully it will become easier and easier for new users to employ best practices which avoid some of the pitfalls mentioned above. Please feel free to contact us if you have any other’s that you’d like to share!</p>

  </article>

</div>
      </div>
    </div>

    <footer class="site-footer">

  <div class="wrap">

    <h2 class="footer-heading">DataFox Tech Blog</h2>

    <div class="footer-col-1 column">
      <ul>
        <li>DataFox Tech Blog</li>
        <li><a href="mailto:"></a></li>
      </ul>
    </div>

    <div class="footer-col-2 column">
      <ul>
        <li>
          <a href="https://github.com/">
            <span class="icon github">
              <svg version="1.1" class="github-icon-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                 viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
                <path fill-rule="evenodd" clip-rule="evenodd" fill="#C2C2C2" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761
                c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32
                c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472
                c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037
                C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65
                c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261
                c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082
                c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129
                c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
              </svg>
            </span>
            <span class="username"></span>
          </a>
        </li>
        <li>
          <a href="https://twitter.com/">
            <span class="icon twitter">
              <svg version="1.1" class="twitter-icon-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                 viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
                <path fill="#C2C2C2" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27
                c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767
                c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206
                C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271
                c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469
                c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
              </svg>
            </span>
            <span class="username"></span>
          </a>
        </li>
      </ul>
    </div>

    <div class="footer-col-3 column">
      <p class="text">DataFox Tech Blog</p>
    </div>

  </div>

</footer>


    </body>
</html>